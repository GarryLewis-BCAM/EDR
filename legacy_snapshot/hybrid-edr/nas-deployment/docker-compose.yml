version: '3.8'

services:
  # Ollama AI Engine (local, no API costs)
  ollama:
    image: ollama/ollama:latest
    container_name: edr-ollama
    volumes:
      - ollama-data:/root/.ollama
    ports:
      - "11434:11434"
    environment:
      - OLLAMA_HOST=0.0.0.0
    restart: unless-stopped
    networks:
      - edr-network
    deploy:
      resources:
        limits:
          memory: 8G
        reservations:
          memory: 4G

  # EDR Collector (monitors NAS)
  edr-collector:
    build: .
    container_name: edr-collector
    volumes:
      # Mount host system for monitoring
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
      - /etc:/host/etc:ro
      # EDR data persistence
      - edr-data:/app/data
      - edr-logs:/app/logs
      - ./config:/app/config:ro
    environment:
      - HOST_PROC=/host/proc
      - HOST_SYS=/host/sys
      - OLLAMA_URL=http://ollama:11434
      - TWILIO_ACCOUNT_SID=dummy
      - TWILIO_AUTH_TOKEN=dummy
      - TWILIO_WHATSAPP_FROM=whatsapp:+14155238886
      - TWILIO_WHATSAPP_TO=whatsapp:+1234567890
      - NAS_IP=192.168.1.80
    depends_on:
      - ollama
    restart: unless-stopped
    network_mode: host
    privileged: true
    pid: host
    deploy:
      resources:
        limits:
          memory: 2G

  # Dashboard (read-only monitoring)
  edr-dashboard:
    build:
      context: .
      dockerfile: Dockerfile.dashboard
    container_name: edr-dashboard
    volumes:
      - edr-data:/app/data:ro
    ports:
      - "5050:5050"
    environment:
      - DATABASE_PATH=/app/data/edr.db
    depends_on:
      - edr-collector
    restart: unless-stopped
    networks:
      - edr-network

  # Fail2Ban (auto-block brute force)
  fail2ban:
    image: crazymax/fail2ban:latest
    container_name: edr-fail2ban
    volumes:
      - /var/log:/var/log:ro
      - fail2ban-data:/data
      - ./fail2ban:/etc/fail2ban:ro
    environment:
      - TZ=Australia/Sydney
      - F2B_DB_PURGE_AGE=30d
    cap_add:
      - NET_ADMIN
      - NET_RAW
    network_mode: host
    restart: unless-stopped

volumes:
  ollama-data:
  edr-data:
  edr-logs:
  fail2ban-data:

networks:
  edr-network:
    driver: bridge
